!function(){"use strict";let t=Date.now();function e(t,e,i){let s=32;for(;s>8&&(e.font="bold "+s+"px sans-serif",!(e.measureText(i).width<=t.width-4));)s--;e.fillStyle="rgba(0, 0, 0, 0.75)",e.fillRect(0,0,t.width,t.height),e.textBaseline="middle";const r=(t.width-e.measureText(i).width)/2,n=t.height/2;e.fillStyle="#000000",e.fillText(i,r+2,n+2),e.fillStyle="#ffffff",e.fillText(i,r,n)}function i(){return Date.now()-t}function s(){return window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB}let r=void 0;document.addEventListener("mousedown",function(t){null==r&&(r=new(window.AudioContext||window.webkitAudioContext))}),document.addEventListener("keydown",function(t){null==r&&(r=new(window.AudioContext||window.webkitAudioContext))});class n{constructor(t){this.lastCurrTime=0,this.lastTimeMs=0,this.timeSpeakerOn=0,this.audioGain=void 0,this.pc_speaker=void 0,this.volume=t&&t.volume||.2}on(t){if(null==r)return;let e=r.currentTime;e!=this.lastCurrTime&&(this.lastCurrTime=e,this.lastTimeMs=i());let s=(i()-this.lastTimeMs)/1e3;null==this.pc_speaker?(this.audioGain=r.createGain(),this.pc_speaker=r.createOscillator(),this.pc_speaker.type="square",this.pc_speaker.frequency.setValueAtTime(t,r.currentTime+s),this.pc_speaker.connect(this.audioGain),this.audioGain.connect(r.destination),this.audioGain.gain.setValueAtTime(this.volume,r.currentTime),this.pc_speaker.start(0)):this.pc_speaker.frequency.setValueAtTime(t,r.currentTime+s),this.timeSpeakerOn=i()}off(){if(null==this.pc_speaker)return;let t=r.currentTime;t!=this.lastCurrTime&&(this.lastCurrTime=t,this.lastTimeMs=i());let e=(i()-this.lastTimeMs)/1e3;this.pc_speaker.frequency.setValueAtTime(0,r.currentTime+e)}}class o{constructor(t,e){if(this.canvas=t,this.blink_duration=e&&e.blink_duration||466,this.ctx=t.getContext("2d",{alpha:!1}),this.ctx.imageSmoothingEnabled=!1,this.video_blink=this.blink_duration>0,e&&e.hasOwnProperty("blink")&&(this.video_blink=e.blink),this.video_mode=-1,this.chrBuf=[],this.drawChrWidth=void 0,this.chrWidth=void 0,this.scrWidth=void 0,this.chrHeight=void 0,this.scrHeight=void 0,this.pw=void 0,this.ph=void 0,this.cw=void 0,this.ch=void 0,this.scale=1,this.asciiFg=null,this.charset=null,this.palette=null,this.rdDirty=!1,this.charset_override_enabled=e&&e.charset_override||!1,this.charset_override=null,this.charset_override_enabled){let t=new Image;t.src=e.charset_override,t.onload=function(){this.charset_override=t,this.rdDirty=!0}}}_updVideoMode(t,e){t!=this.video_mode&&(this.chrBuf=[],this.scrWidth=2==(2&t)?80:40,this.scrHeight=25,this.video_mode=t),this.drawChrWidth=this.chrWidth*(80/this.scrWidth),this.pw=this.scrWidth*this.drawChrWidth,this.ph=this.scrHeight*this.chrHeight,this.cw=this.canvas.width,this.ch=this.canvas.height,this.scale=Math.min(Math.floor(this.cw/this.pw),Math.floor(this.ch/this.ph)),this.video_blink?e%this.blink_duration>=this.blink_duration/2?this.blink_state=2:this.blink_state=1:this.blink_state=0,this.x_offset=(this.cw-this.pw*this.scale)/2,this.y_offset=(this.ch-this.ph*this.scale)/2}_drawChar(t,e,i,s){switch(this.blink_state){case 0:break;case 1:s&=127;break;case 2:s>=128&&(s=17*((112&s)>>4))}const r=i<<8|s;if(this.chrBuf[80*e+t]==r)return;this.chrBuf[80*e+t]=r,t=t*this.drawChrWidth*this.scale+this.x_offset,e=e*this.chrHeight*this.scale+this.y_offset;const n=s>>4&15,o=15&s;let a=this.drawChrWidth*this.scale,h=this.chrHeight*this.scale;this.ctx.fillStyle=this.palette[n],this.ctx.fillRect(t,e,a,h),n!=o&&this.ctx.drawImage(this.asciiFg[o],(15&i)*this.chrWidth,(i>>4&15)*this.chrHeight,this.chrWidth,this.chrHeight,t,e,a,h)}_updRenderData(){if(null==this.palette)return;let t=null;if(this.charset_override_enabled){if(null==this.charset_override)return;t=this.charset_override}else if(null==this.charset)return;if(this.asciiFg=[],null==t){let a=document.createElement("canvas");a.width=16*this.chrWidth,a.height=16*this.chrHeight;let h=a.getContext("2d"),l=h.createImageData(a.width,a.height),c=l.data,u=0;for(var e=0;e<256;e++){let t=(15&e)*this.chrWidth,h=(e>>4)*this.chrHeight;for(var i=0;i<this.chrHeight;i++,u++)for(var s=(h+i)*a.width+t,r=this.charset[u],n=0;n<this.chrWidth;n++,s++,r<<=1){var o=255*(r>>7&1);c[4*s+0]=o,c[4*s+1]=o,c[4*s+2]=o,c[4*s+3]=o}}h.putImageData(l,0,0),t=a}this.asciiFg[15]=t;for(var a=0;a<15;a++){let e=document.createElement("canvas");e.width=16*this.chrWidth,e.height=16*this.chrHeight;let i=e.getContext("2d");i.globalCompositeOperation="copy",i.drawImage(t,0,0),i.globalCompositeOperation="source-in",i.fillStyle=this.palette[a],i.fillRect(0,0,e.width,e.height),this.asciiFg[a]=e}this.rdDirty=!1}render(t,e,i){this.rdDirty&&this._updRenderData(),this._updVideoMode(e,i);let s=0;if(null!=this.asciiFg&&null!=this.palette)for(var r=0;r<25;r++)for(var n=0;n<this.scrWidth;n++,s+=2)this._drawChar(n,r,t[s],t[s+1])}setCharset(t,e,i){this.chrWidth=t,this.chrHeight=e,this.charset=i,this.rdDirty=!0}setPalette(t){this.palette=new Array;for(var e=0;e<16;e++){let i=(16777215&t[e]).toString(16);for(;i.length<6;)i="0"+i;this.palette[e]="#"+i}this.rdDirty=!0}}function a(t,e){if(null==e)return t;let i=[];for(var s=0;s<t.length;s++){const r=t[s];e(r)&&i.push(r)}return i}class h{constructor(t,e){for(var i in this.map={},t)this.map[i.toUpperCase()]=t[i];this.readonly=e&&e.readonly||!1}canSet(t){return this.readonly}get(t){return this.map.hasOwnProperty(t.toUpperCase())?this.map[t.toUpperCase()].slice(0):null}list(t){return a(Object.keys(this.map),t)}set(t,e){return!this.readonly&&(this.map[t.toUpperCase()]=e,!0)}}class l{constructor(t){this.providers=t}canSet(t){for(var e=0;e<this.providers.length;e++){if(this.providers[e].canSet(t))return!0}return!1}get(t){for(var e=this.providers.length-1;e>=0;e--){const i=this.providers[e].get(t);if(null!=i)return i}return null}list(t){let e=[];for(var i=0;i<this.providers.length;i++){let s=this.providers[i];e=e.concat(s.list(t))}return e.sort().filter(function(t,e,i){return e<=0||t!=i[e-1]})}set(t,e){for(var i=this.providers.length-1;i>=0;i--){if(this.providers[i].set(t,e))return!0}return!1}}class c extends h{constructor(t){super({},{}),this.parent=t}_populate(){const t=this;return this.parent.list(null).then(e=>{t.map={};let i=[];for(var s=0;s<e.length;s++){const r=e[s];i.push(t.parent.get(r).then(e=>{t.map[r.toUpperCase()]=e}))}return Promise.all(i)})}set(t,e){return!!super.set(t,e)&&(this.parent.set(t,e),!0)}}class u{constructor(t,e){this.storage=t,this.prefix=e+"_file_"}canSet(t){return!0}get(t){const e=this.storage.getItem(this.prefix+t.toUpperCase());return e?e.split(",").map(t=>parseInt(t)):null}list(t){for(var e=[],i=0;i<this.storage.length;i++){const t=this.storage.key(i);t.startsWith(this.prefix)&&e.push(t.substring(this.prefix.length))}return a(e,t)}set(t,e){return this.storage.setItem(this.prefix+t.toUpperCase(),e.join(",")),!0}}class d{constructor(t,e,i){this.indexedDB=t,this.dbName=e}_open(){const t=this;return new Promise((e,i)=>{var s=t.indexedDB.open(this.dbName,1);s.onupgradeneeded=e=>{t.database=e.target.result,t.files=t.database.createObjectStore("files",{keyPath:"filename"})},s.onsuccess=i=>{t.database=s.result,e()},s.onerror=t=>{i()}})}canSet(t){return Promise.resolve(!0)}get(t){const e=this.database.transaction(["files"],"readonly");return new Promise((i,s)=>{const r=e.objectStore("files").get(t.toUpperCase());r.onsuccess=t=>{r.result&&r.result.value?i(r.result.value):i(null)},r.onerror=t=>{i(null)}})}list(t){const e=this.database.transaction(["files"],"readonly");return new Promise((i,s)=>{const r=e.objectStore("files").getAllKeys();r.onsuccess=e=>{i(a(r.result,t))},r.onerror=t=>{i([])}})}set(t,e){const i=this.database.transaction(["files"],"readwrite");return new Promise((s,r)=>{const n=i.objectStore("files").put({filename:t.toUpperCase(),value:e});n.onsuccess=t=>{s(!0)},n.onerror=t=>{s(!1)}})}}function f(t,e){return new h(t,e)}function p(t,e,i){return new Promise((s,r)=>{var n=new XMLHttpRequest;n.open("GET",t,!0),n.responseType="arraybuffer",n.onprogress=function(t){null!=i&&i(t.loaded/t.total)},n.onload=function(){if(null!=i&&i(1),200!=n.status)return void r("Error downloading "+t+" ("+n.status+")");let o=UZIP.parse(this.response),a={};for(var l in o){const i=l;if(e&&e.filenameMap)if("object"==typeof e.filenameMap)l=e.filenameMap[l]||void 0;else if("string"==typeof e.filenameMap&&e.filenameMap.length>0){let t=e.filenameMap.toLowerCase();t.endsWith("/")||(t+="/"),l=l.toLowerCase().startsWith(t)?l.substring(t.length):void 0}else"function"==typeof e.filenameMap&&(l=e.filenameMap(l));l&&l.indexOf("/")>=0&&(console.warn("skipped file inside subdirectory: "+t+" -> "+l),l=void 0),l&&(e&&e.filenameFilter&&!e.filenameFilter(l)||(a[l]=o[i]))}s(new h(a,e))},n.send()})}let _={ArrowUp:72,ArrowLeft:75,ArrowRight:77,ArrowDown:80,Home:71,End:79,Insert:82,Delete:83,PageUp:73,PageDown:81,Enter:28,Escape:1,Backspace:14,Tab:15,"-":12,_:12,"=":13,"+":13,"`":41,"~":41,"\\":43,"|":43,"*":55," ":57},g=function(t,e){for(var i=0;i<t.length;i++)_[t.charAt(i)]=e+i};g("1234567890",2),g("QWERTYUIOP{}",16),g("qwertyuiop[]",16),g("asdfghjkl;'",30),g('ASDFGHJKL:"',30),g("zxcvbnm,./",44),g("ZXCVBNM<>?",44);for(var m=1;m<=10;m++)_["F"+m]=58+m;const w=_;let v,y=f({}),k={};function b(t){v=t}function z(t){y=t}function x(){window.vfsg_open=function(t,e){"string"!=typeof t&&(t=v.AsciiToString(t)),t=t.toUpperCase();let i=y.get(t);const s=1==(3&e);if(s){if(!y.canSet(t))return-1;null!=i&&0==(65536&e)||(i=new Uint8Array(0))}else if(null==i)return-1;console.log("opening "+t);let r=1;for(;r in k;)r++;return k[r]={fn:t,pos:0,mode:e,write_on_close:s,array:i},r},window.vfsg_close=function(t){return t in k?(k[t].write_on_close&&y.set(k[t].fn,k[t].array),delete k[t],0):-1},window.vfsg_seek=function(t,e,i){if(!(t in k))return-1;let s;switch(i){case 0:s=e;break;case 1:s=k[t].pos+e;break;case 2:s=k[t].array.length+e}return console.log("seek to "+s),s>k[t].array.length?s=k[t].array.length:s<0&&(s=0),k[t].pos=s,0},window.vfsg_read=function(t,e,i){if(!(t in k))return-1;t=k[t];let s=Math.min(i,t.array.length-t.pos);console.log("reading "+s+" bytes from "+t.pos+" to "+e);const r=new Uint8Array(v.HEAPU8.buffer,e,s);for(var n=0;n<s;n++)r[n]=t.array[t.pos+n];return console.log("read "+s+" bytes"),t.pos+=s,s},window.vfsg_write=function(t,e,i){if(!(t in k))return-1;let s=(t=k[t]).array.length,r=t.pos+i;if(r>s){var n=new Uint8Array(r);n.set(t.array,0),t.array=n,s=r}let o=new Uint8Array(v.HEAPU8.buffer,e,i);for(var a=0;a<i;a++)t.array[t.pos+a]=o[a];return console.log("wrote "+i+" bytes"),t.pos+=i,i};var t=[],e=0;window.vfsg_findfirst=function(i,s,r){r=v.AsciiToString(r),t=[];const n=function(t){if((t=t.toUpperCase()).startsWith("*.")){let e=t.substring(1),i=y.list(t=>t.endsWith(e));return i.sort((t,e)=>{const i=t.length-e.length;return 0!=i?i:t.localeCompare(e)}),i}return console.log("unknown findfirst spec: "+t),null}(r);return null==n?-1:(t=n,e=0,vfsg_findnext(i))},window.vfsg_findnext=function(i){if(e>=t.length)return-1;const s=new Uint8Array(v.HEAPU8.buffer,i,256);s[21]=0,s[22]=0,s[23]=0,s[24]=0,s[25]=0;let r=t[e],n=y.get(r).byteLength;s[26]=255&n,s[27]=n>>8&255,s[28]=n>>16&255,s[29]=n>>24&255;for(var o=0;o<r.length;o++)s[30+o]=r.charCodeAt(o);return s[30+r.length]=0,e+=1,0}}const C=1e3/18.2;class A{constructor(t,e,s,r,n,o){this.element=t,this.emu=e,this.render=s,this.audio=r,this.vfs=n,this.mouseSensitivity=o&&o.mouseSensitivity||4,this.frameQueued=!1,this.time_ms_cached=i(),this.last_timer_time=0,this.opcodes=1e3;const a=this;window.vfsg_time_ms=function(){return a.time_ms_cached},window.vfsg_has_feature=function(t){return 1==t||2==t},window.zetag_update_charset=function(t,i,r){const n=new Uint8Array(e.HEAPU8.buffer,r,256*i);s.setCharset(t,i,n)},window.zetag_update_palette=function(t){const i=new Uint32Array(e.HEAPU32.buffer,t,16);s.setPalette(i)},window.speakerg_on=function(t){document.hasFocus()?null!=r&&r.on(t):speakerg_off()},window.speakerg_off=function(){null!=r&&r.off()},window.addEventListener("message",function(t){"zzt_tick"==t.data&&(t.stopPropagation(),a._tick())},!0),document.addEventListener("keydown",function(i){if(i.target!=t)return!1;let s=!1;"Shift"==i.key?e._zzt_kmod_set(1):"Control"==i.key?e._zzt_kmod_set(4):"Alt"==i.key||"AltGraph"==i.key?e._zzt_kmod_set(8):s=!1;let r=1==i.key.length?i.key.charCodeAt(0):i.keyCode<32?i.keyCode:0,n=w[i.key]||0;return n>=70&&n<=83&&(r=0),(r>0||n>0)&&(e._zzt_key(r,n),s=!0),s&&i.preventDefault(),!1},!1),document.addEventListener("keyup",function(i){if(i.target!=t)return!1;let s=!0;"Shift"==i.key?e._zzt_kmod_clear(1):"Control"==i.key?e._zzt_kmod_clear(4):"Alt"==i.key||"AltGraph"==i.key?e._zzt_kmod_clear(8):s=!1;var r=w[i.key]||0;return r>0&&(e._zzt_keyup(r),s=!0),s&&i.preventDefault(),!1},!1),this.element.addEventListener("mousemove",function(t){if(null==e)return;const i=t.movementX*a.mouseSensitivity,s=t.movementY*a.mouseSensitivity;e._zzt_mouse_axis(0,i),e._zzt_mouse_axis(1,s)}),this.element.addEventListener("mousedown",function(i){t.requestPointerLock(),null!=e&&e._zzt_mouse_set(i.button)}),this.element.addEventListener("mouseup",function(t){null!=e&&e._zzt_mouse_clear(t.button)})}_frame(){this._pollGamepads();const t=this.emu._zzt_get_ram(),e=new Uint8Array(this.emu.HEAPU8.buffer,t+753664,4e3);this.render.render(e,this.emu._zzt_video_mode(),this.time_ms_cached),this.emu._zzt_mark_frame(),this.frameQueued=!1}_resetLastTimerTime(){this.last_timer_time=i()}_tick(){for(this.time_ms_cached=i();this.time_ms_cached-this.last_timer_time>=C;)this.last_timer_time+=C,this.emu._zzt_mark_timer();const t=this.emu._zzt_execute(this.opcodes),s=i()-this.time_ms_cached;if(t){1==t&&(s<4?this.opcodes=20*this.opcodes/19:s>8&&(this.opcodes=19*this.opcodes/20)),this.frameQueued||(this.frameQueued=!0,window.requestAnimationFrame(()=>this._frame()));const e=C-(this.time_ms_cached+s-this.last_timer_time);3!=t||e<=1?window.postMessage("zzt_tick","*"):setTimeout(()=>this._tick(),e)}else e(this.render.canvas,this.render.ctx,"Emulation stopped.")}_pollGamepads(){const t=navigator.getGamepads();for(var e=0;e<t.length;e++){const s=t[e];if(null!=s&&s.axes.length>=2&&s.buttons.length>=1){const t=Math.round(127*s.axes[0]),e=Math.round(127*s.axes[1]);this.emu._zzt_joy_axis(0,t),this.emu._zzt_joy_axis(1,e);let r=!1;for(var i=0;i<s.buttons.length;i++)if(s.buttons[i].pressed){r=!0;break}r?this.emu._zzt_joy_set(0):this.emu._zzt_joy_clear(0)}}}}const T="beta14";class S{constructor(t,e,i,s){this.canvas=t,this.ctx=e,this.loaded=!1,this.path=s.path}_drawBackground(){const t=this;return new Promise((e,i)=>{const s=new Image;s.onload=function(){const i=T,r=s.width,n=s.height;t.ctx.drawImage(s,0,0,r,n,(t.canvas.width-2*r)/2,(t.canvas.height-2*n)/2,2*r,2*n),t.ctx.font="16px sans-serif",t.ctx.fillStyle="#aaaaaa",t.ctx.textBaseline="bottom",t.ctx.fillText(i,(t.canvas.width+2*r)/2-6-t.ctx.measureText(i).width,(t.canvas.height+2*n)/2-6),t.loaded=!0,e(!0)},s.src=t.path+"loading.png"})}progress(t){if(!this.loaded)return;const e=this.canvas,i=this.ctx,s=(e.width-640)/2,r=(e.height-350)/2;i.fillStyle="#ff0000",i.fillRect(s+28,r+224,292*t*2,20)}}window.ZetaInitialize=function(t){if(console.log("         _        \n _______| |_ __ _ \n|_  / _ \\ __/ _` |\n / /  __/ || (_| |\n/___\\___|\\__\\__,_|\n\n "+T),!t.render)throw"Missing option: render!";if(!t.render.canvas)throw"Missing option: render.canvas!";const i=t.render.canvas;i.contentEditable=!0;const r=i.getContext("2d",{alpha:!1});r.imageSmoothingEnabled=!1;try{if(!t.path)throw"Missing option: path!";if(!t.files)throw"Missing option: files!"}catch(t){return e(i,r,t),Promise.reject(t)}const a=new S(i,r,T,t);var h=[],_=[],g=[];for(var m in t.files){_.push(0);const e=t.files[m],i=_.length-1,s=function(e){_[i]=Math.min(e,1),a.progress(_.reduce((t,e)=>t+e)/t.files.length)};if(Array.isArray(e)){var w=e[1];w.hasOwnProperty("readonly")||(w.readonly=!0),h.push(p(e[0],w,s).then(t=>g.push(t)))}else h.push(p(e,{readonly:!0},s).then(t=>g.push(t)))}return a._drawBackground().then(t=>Promise.all(h)).then(e=>{if("auto"==t.storage.type&&(null!=s()?t.storage.type="indexeddb":null!=window.localStorage?t.storage.type="localstorage":(console.log("Browser does not support any form of local storage! Storing to memory..."),t.storage=void 0)),t.storage&&t.storage.type){if("indexeddb"==t.storage.type){if(!t.storage.database)throw"Missing option: storage.database!";return function(t){const e=s();if(!e)return Promise.reject("IndexedDB not supported!");const i=new d(e,t);return i._open().then(t=>i)}("zeta_"+t.storage.database).then(t=>(function(t){const e=new c(t);return e._populate().then(t=>e)})(t)).then(t=>g.push(t))}if("localstorage"==t.storage.type){if(!t.storage.database)throw"Missing option: storage.database!";let e=window.localStorage;if(t.storage.storage&&(e=t.storage.storage),null==e)throw"Could not find storage object!";return g.push(function(t,e){return new u(t,e)}(e,"zeta_"+t.storage.database)),!0}throw"Unknown storage type: "+t.storage.type}return g.push(f({},{readonly:!1})),!0}).then(e=>{return function(t,e,i,s){return new Promise(r=>{ZetaNative().then(n=>{z(i),b(n),x();const o=new A(s.render.canvas,n,t,e,i,s);n._zzt_init();let a=vfsg_open("zzt.exe",0),h=".zzt";if(a<0&&(a=vfsg_open("superz.exe",0),h=void 0),a<0)throw"Could not find ZZT executable!";let l="";if(s&&s.arg)l=s.arg;else if(null!=h){let t=i.list(t=>t.toLowerCase().endsWith(h));t.length>0&&(l=t[0])}const c=n._malloc(l.length+1),u=new Uint8Array(n.HEAPU8.buffer,c,l.length+1);for(var d=0;d<l.length;d++)u[d]=l.charCodeAt(d);u[l.length]=0,n._zzt_load_binary(a,c),vfsg_close(a),n._zzt_set_timer_offset(Date.now()%864e5),o._resetLastTimerTime(),o._tick(),r(o)})})}(new o(t.render.canvas,t.render),new n(t.audio),function(t){return new l(t)}(g),t)}).then(t=>!0).catch(t=>{e(i,r,t)})}}();
