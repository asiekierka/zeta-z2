zzt_kbdmap={ArrowUp:72,ArrowLeft:75,ArrowRight:77,ArrowDown:80,Home:71,End:79,Insert:82,Delete:83,PageUp:73,PageDown:81,Enter:28,Escape:1,"-":12,_:12,"=":13,"+":13,Backspace:14,Tab:15};var addCharsInOrder=function(r,a){for(var d=0;d<r.length;d++)zzt_kbdmap[r.charAt(d)]=a+1+d};addCharsInOrder("1234567890",0),addCharsInOrder("QWERTYUIOP{}",15),addCharsInOrder("qwertyuiop[]",15),addCharsInOrder("asdfghjkl;'",29),addCharsInOrder('ASDFGHJKL:"',29),addCharsInOrder("zxcvbnm,./",43),addCharsInOrder("ZXCVBNM<>?",43),zzt_kbdmap["`"]=41,zzt_kbdmap["~"]=41,zzt_kbdmap["\\"]=43,zzt_kbdmap["|"]=43,zzt_kbdmap["*"]=55,zzt_kbdmap[" "]=57;for(var i=1;i<=10;i++)zzt_kbdmap["F"+i]=58+i;
var canvas=document.getElementById("zzt_canvas"),ctx=canvas.getContext("2d",{alpha:!1});ctx.imageSmoothingEnabled=!1;var asciiImg=new Image,asciiFg=[],emu=void 0,palette=["#000000","#0000AA","#00AA00","#00AAAA","#AA0000","#AA00AA","#AA5500","#AAAAAA","#555555","#5555FF","#55FF55","#55FFFF","#FF5555","#FF55FF","#FFFF55","#FFFFFF"],chrBuf=(asciiFg=[],[]),date_s=Date.now(),time_ms=function(){return Date.now()-date_s},video_blink=!1,video_mode=3,last_video_mode=3,drawChar=function(x,y,chr,col){video_mode!=last_video_mode&&(chrBuf=[],last_video_mode=video_mode);var width=16;2==(2&video_mode)&&(width=8);var buffered=chrBuf[80*(y*=14)+(x*=width)];video_blink&&128<=col&&(col&=127,233<=vfsg_time_ms()%466&&(col=17*(col>>4)));var bufcmp=chr<<8|col;if(buffered!=bufcmp){chrBuf[80*y+x]=bufcmp;var bg=col>>4&15,fg=15&col,rw=width,rh=14,pw=80*rw,ph=25*rh,cw=canvas.width,ch=canvas.height,scale=Math.min(Math.floor(cw/pw),Math.floor(ch/ph));1<scale?(rw*=scale,rh*=scale,x=x*scale+(cw-pw*scale)/2,y=y*scale+(ch-ph*scale)/2):(x+=(cw-pw)/2,y+=(ch-ph)/2),ctx.fillStyle=palette[bg],ctx.fillRect(x,y,rw,rh),bg!=fg&&0!=chr&&32!=chr&&ctx.drawImage(asciiFg[fg],8*(15&chr),14*((240&chr)>>4),8,14,x,y,rw,rh)}},vfs_progress={},vfs={},vfs_append=function(fn,then){var fnfilter=function(f){return!0};Array.isArray(fn)&&(fnfilter=fn[1],fn=fn[0]);var xhr=new XMLHttpRequest;xhr.open("GET",fn,!0),xhr.responseType="arraybuffer",xhr.onprogress=function(event){vfs_progress[fn]=event.loaded/event.total,draw_progress(get_vfs_prog_total()/vfs_files.length)},xhr.onload=function(){vfs_progress[fn]=0;var files=UZIP.parse(this.response);for(var key in files)if(fnfilter(key)){var ku=key.toUpperCase();vfs[ku]={readonly:!0,buffer:files[key]}}then()},xhr.send()},handles={};function zetag_update_charset(width,height,char_ptr){}function vfsg_has_feature(id){return 1==id||2==id}function vfsg_open(fn,mode){if("string"!=typeof fn&&(fn=emu.Pointer_stringify(fn)),fn=fn.toUpperCase(),1==(3&mode)){if(fn in vfs&&vfs[fn].readonly)return-1;fn in vfs&&0==(65536&mode)||(vfs[fn]={readonly:!1,buffer:new Uint8Array(0)})}else if(!(fn in vfs))return-1;console.log("opening "+fn);for(var i=1;i in handles;)i++;return handles[i]={name:fn,pos:0,mode:mode,array:vfs[fn].buffer,obj:vfs[fn]},i}function vfsg_close(h){return h in handles?(delete handles[h],0):-1}function vfsg_seek(h,pos,type){if(!(h in handles))return-1;var newpos=pos;return 1==type?newpos+=handles[h].pos:2==type&&(newpos+=handles[h].array.length),console.log("seek to "+newpos),newpos>handles[h].array.length?newpos=handles[h].array.length:newpos<0&&(newpos=0),handles[h].pos=newpos,0}function vfsg_read(h,ptr,amount){if(!(h in handles))return-1;h=handles[h];var maxlen=Math.min(amount,h.array.length-h.pos);console.log("reading "+maxlen+" bytes from "+h.pos+" to "+ptr);for(var heap=new Uint8Array(emu.HEAPU8.buffer,ptr,maxlen),pos=0;pos<maxlen;pos++)heap[pos]=h.array[h.pos+pos];return console.log("read "+maxlen+" bytes"),h.pos+=maxlen,maxlen}function vfsg_write(h,ptr,amount){if(!(h in handles))return-1;var len=(h=handles[h]).array.length,newlen=h.pos+amount;if(len<newlen){var newA=new Uint8Array(newlen);newA.set(h.array,0),h.obj.buffer=newA,h.array=newA,len=newlen}for(var heap=new Uint8Array(emu.HEAPU8.buffer,ptr,amount),pos=0;pos<amount;pos++)h.array[h.pos+pos]=heap[pos];return console.log("wrote "+amount+" bytes"),h.pos+=amount,amount}var ff_list=[],ff_pos=0,vfs_list=function(spec){var list=[];if((spec=spec.toUpperCase()).startsWith("*.")){var suffix=spec.substring(1);for(var key in vfs)key.endsWith(suffix)&&list.push(key);return list.sort(function(a,b){var lenDiff=a.length-b.length;return 0!=lenDiff?lenDiff:a.localeCompare(b)}),list}return console.log("unknown findfirst spec: "+spec),null};function vfsg_findfirst(ptr,mask,spec){spec=emu.Pointer_stringify(spec),ff_list=[];var l=vfs_list(spec);return null==l?-1:(ff_list=l,ff_pos=0,vfsg_findnext(ptr))}function vfsg_findnext(ptr){if(ff_pos>=ff_list.length)return-1;var finddata=new Uint8Array(emu.HEAPU8.buffer,ptr,256);finddata[21]=0,finddata[22]=0,finddata[23]=0,finddata[24]=0,finddata[25]=0;var size=vfs[ff_list[ff_pos]].buffer.length;finddata[26]=255&size,finddata[27]=size>>8&255,finddata[28]=size>>16&255,finddata[29]=size>>24&255;for(var fn=ff_list[ff_pos],i=0;i<fn.length;i++)finddata[30+i]=fn.charCodeAt(i);return finddata[30+fn.length]=0,ff_pos+=1,0}var queuedFrame=!1,zzt_frame=function(){poll_gamepads(),video_mode=emu._zzt_video_mode();var ptr=emu._zzt_get_ram(),heap=new Uint8Array(emu.HEAPU8.buffer,ptr+753664,4e3),width=40,pos=0;2==(2&video_mode)&&(width=80);for(var y=0;y<25;y++)for(var x=0;x<width;x++,pos+=2)drawChar(x,y,heap[pos],heap[pos+1]);emu._zzt_mark_frame(),queuedFrame=!1},last_timer_time=0,timer_dur=1e3/18.2,vfsg_time_ms_val=0;function vfsg_time_ms(){return vfsg_time_ms_val}var opcodes=1e3,zzt_tick=function(){vfsg_time_ms_val=time_ms();for(var tms=vfsg_time_ms();timer_dur<=tms-last_timer_time;)last_timer_time+=timer_dur,emu._zzt_mark_timer();var rcode=emu._zzt_execute(opcodes),duration=time_ms()-tms;rcode&&(1==rcode&&(duration<3?opcodes=20*opcodes/19:6<duration&&(opcodes=19*opcodes/20)),queuedFrame||(queuedFrame=!0,window.requestAnimationFrame(zzt_frame)),document.hasFocus()&&3!=rcode?window.postMessage("zzt_tick","*"):setTimeout(zzt_tick,20))};window.addEventListener("message",function(event){"zzt_tick"==event.data&&(event.stopPropagation(),zzt_tick())},!0);var vfs_arg=null,vfs_done=function(){if(null==vfs_arg||""==vfs_arg)if("ZZT.EXE"in vfs&&!("TOWN.ZZT"in vfs))0<(zlist=vfs_list("*.ZZT")).length&&(vfs_arg=zlist[0]);else if("SUPERZ.EXE"in vfs&&!("MONSTER.SZT"in vfs)){var zlist;0<(zlist=vfs_list("*.SZT")).length&&(vfs_arg=zlist[0])}video_blink=!("BLINKX.COM"in vfs),vfs_arg=(vfs_arg||"").toUpperCase(),draw_progress(1),Zeta().then(function(c){for(var buffer=(emu=c)._malloc(vfs_arg.length+1),heap=new Uint8Array(emu.HEAPU8.buffer,buffer,vfs_arg.length+1),i=0;i<vfs_arg.length;i++)heap[i]=vfs_arg.charCodeAt(i);heap[vfs_arg.length]=0,emu._zzt_init();var handle=vfsg_open("zzt.exe",0);if(handle<0&&(handle=vfsg_open("superz.exe",0)),handle<0)throw"Could not find ZZT executable!";emu._zzt_load_binary(handle,buffer),vfsg_close(handle);emu._zzt_get_ram();last_timer_time=time_ms(),zzt_tick()})},audioCtx=void 0,pc_speaker=void 0,initAudioCtx=function(){null!=emu&&(audioCtx=new(window.AudioContext||window.webkitAudioContext))};document.addEventListener("mousedown",function(event){null==audioCtx&&initAudioCtx()});var lastCurrTime=0,lastTimeMs=0,timeSpeakerOn=0,audioGain=void 0;function speakerg_on(freq){if(document.hasFocus()){if(null!=audioCtx){var cTime=audioCtx.currentTime;cTime!=lastCurrTime&&(lastCurrTime=cTime,lastTimeMs=time_ms());var lastADelay=(time_ms()-lastTimeMs)/1e3;null==pc_speaker?(audioGain=audioCtx.createGain(),(pc_speaker=audioCtx.createOscillator()).type="square",pc_speaker.frequency.setValueAtTime(freq,audioCtx.currentTime+lastADelay),pc_speaker.connect(audioGain),audioGain.connect(audioCtx.destination),audioGain.gain.setValueAtTime(.2,audioCtx.currentTime),pc_speaker.start(0)):pc_speaker.frequency.setValueAtTime(freq,audioCtx.currentTime+lastADelay),timeSpeakerOn=time_ms()}}else speakerg_off()}function speakerg_off(){if(null!=pc_speaker){var cTime=audioCtx.currentTime;cTime!=lastCurrTime&&(lastCurrTime=cTime,lastTimeMs=time_ms());var lastADelay=(time_ms()-lastTimeMs)/1e3;pc_speaker.frequency.setValueAtTime(0,audioCtx.currentTime+lastADelay)}}canvas.contentEditable=!0,document.addEventListener("keydown",function(event){if(event.target!=canvas)return!1;var ret=!1;null==audioCtx&&initAudioCtx(),"Shift"==event.key?emu._zzt_kmod_set(1):"Control"==event.key?emu._zzt_kmod_set(4):"Alt"==event.key||"AltGraph"==event.key?emu._zzt_kmod_set(8):ret=!1;var chr=1==event.key.length?event.key.charCodeAt(0):event.keyCode<32?event.keyCode:0,key=zzt_kbdmap[event.key]||0;return 70<=key&&key<=83&&(chr=0),(0<chr||0<key)&&(emu._zzt_key(chr,key),ret=!0),ret&&event.preventDefault(),!1},!1),document.addEventListener("keyup",function(event){if(event.target!=canvas)return!1;var ret=!0;"Shift"==event.key?emu._zzt_kmod_clear(1):"Control"==event.key?emu._zzt_kmod_clear(4):"Alt"==event.key||"AltGraph"==event.key?emu._zzt_kmod_clear(8):ret=!1;var key=zzt_kbdmap[event.key]||0;return 0<key&&(emu._zzt_keyup(key),ret=!0),ret&&event.preventDefault(),!1},!1);var vfs_files=[],vfs_files_pos=0,draw_progress=function(p){var cx=(canvas.width-640)/2,cy=(canvas.height-350)/2;ctx.fillStyle="#ff0000",ctx.fillRect(cx+28,cy+224,292*p*2,20)},get_vfs_prog_total=function(){var i=vfs_files_pos;for(var k in vfs_progress)i+=vfs_progress[k];return i},vfs_on_loaded=function(){vfs_files_pos+=1,draw_progress(get_vfs_prog_total()/vfs_files.length),vfs_files_pos==vfs_files.length&&vfs_done()},poll_gamepads=function(){for(var gamepads=navigator.getGamepads(),i=0;i<gamepads.length;i++){var gamepad=gamepads[i];if(null!=gamepad&&(2<=gamepad.axes.length&&1<=gamepad.buttons.length)){var ax0=gamepad.axes[0],ax1=gamepad.axes[1];ax0=Math.round(127*ax0),ax1=Math.round(127*ax1),emu._zzt_joy_axis(0,ax0),emu._zzt_joy_axis(1,ax1),emu._zzt_joy_clear(0);for(var j=0;j<gamepad.buttons.length;j++)if(gamepad.buttons[j].pressed){emu._zzt_joy_set(0);break}}}},mouseSensitivity=4,attach_mouse_handler=function(o){o.addEventListener("mousemove",function(e){if(null!=emu){var mx=e.movementX*mouseSensitivity,my=e.movementY*mouseSensitivity;emu._zzt_mouse_axis(0,mx),emu._zzt_mouse_axis(1,my)}}),o.addEventListener("mousedown",function(e){o.requestPointerLock(),null!=emu&&emu._zzt_mouse_set(e.button)}),o.addEventListener("mouseup",function(e){null!=emu&&emu._zzt_mouse_clear(e.button)})};function zzt_emu_create(options){asciiImg.src=options.charset_png||options.path+"ascii.png",asciiImg.onload=function(){asciiFg[15]=asciiImg;for(var i=0;i<15;i++){var charCanvas=document.createElement("canvas");charCanvas.width=128,charCanvas.height=224;var charCtx=charCanvas.getContext("2d");charCtx.globalCompositeOperation="copy",charCtx.drawImage(asciiImg,0,0),charCtx.globalCompositeOperation="source-in",charCtx.fillStyle=palette[i],charCtx.fillRect(0,0,128,224),asciiFg[i]=charCanvas}for(var s in attach_mouse_handler(canvas),vfs_files=options.files,vfs_arg=options.arg,vfs_files)vfs_append(vfs_files[s],vfs_on_loaded)}}
